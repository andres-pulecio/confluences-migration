# This script logs in to a Confluence website using provided credentials, navigates to a list of URLs, saves each page as a web archive (MHTML format),
# and then compresses the downloaded files into individual tar.gz archives. Finally, it moves the resulting archives to a specified directory.

# Note: Please replace the "<PASSWORD>" placeholder in the "headers" dictionary with a valid access for Confluence.

# Author: Andres Pulecio (apulecio)

# Import necessary modules
from selenium import webdriver
from selenium.webdriver import ActionChains
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.chrome.service import Service
import time
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
import pyautogui
import os
import subprocess

# Confluences Credentials
username = "apulecio"
password = "<PASSWORD>"

# Function to save a web page using the context menu in Chrome
def save_page_with_context_menu(url):
    # Initialize Chrome driver
    driver = webdriver.Chrome()
    
    # Open the provided URL
    driver.get(url)
    
    # Enter username and password and click login button
    driver.find_element("id", "os_username").send_keys(username)
    driver.find_element("id", "os_password").send_keys(password)
    driver.find_element("id", "loginButton").click()
    
    # Wait for the page to load completely
    WebDriverWait(driver=driver, timeout=10).until(
        lambda x: x.execute_script("return document.readyState === 'complete'")
    )
    
    # Check for login errors
    error_message = "Incorrect username or password."
    errors = driver.find_elements("css selector", ".flash-error")
    if any(error_message in e.text for e in errors):
        print("[!] Login failed")
    else:
        print("[+] Login successful")
        
    # Wait for a few seconds before saving the page
    time.sleep(3)    
    
    # Get the body element of the page
    body = driver.find_element("id", "com-atlassian-confluence")
    
    # Simulate a right-click on the page
    actions = ActionChains(driver)
    actions.context_click(body).perform()
    
    # Simulate the keyboard shortcut Cmd + S to open the "Save As" dialog
    pyautogui.hotkey('command', 's')
    
    # Wait a few seconds for the "Save As" dialog to appear
    time.sleep(4)
    
    # Simulate the Enter key to confirm the "Save As" action
    pyautogui.press('enter')
    time.sleep(4)
    
    # Simulate the Enter key multiple times to confirm the save action and close any pop-ups
    pyautogui.press('enter')
    pyautogui.press('enter')
    pyautogui.press('enter')
    
    # Wait a few seconds for the download to complete
    time.sleep(3)
    
    # Check for any errors after saving the page
    error_message = "Incorrect username or password."
    errors = driver.find_elements("css selector", ".flash-error")
    if any(error_message in e.text for e in errors):
        print("[!] Save failed")
    else:
        print("[+] Save successful")
    
    # Wait for a few seconds before proceeding to the next URL
    time.sleep(5)    

    # Close the browser
    driver.quit()

# Function to execute a Linux shell command and capture the output
def ejecutar_comando_linux(comando):
    try:
        salida = subprocess.check_output(comando, shell=True, stderr=subprocess.STDOUT, text=True)
        return True, salida.strip()
    except subprocess.CalledProcessError as e:
        return False, e.output.strip()

# Main function
def main():
    # List of URLs to save
    urls_to_save = [
        '239602325','237171031','270531258','250357960','270518659','272260528','276759437','193910619','194917820','216826988','221071772','226119198','334266306','279995833','258102957','290122410','292199416','338577622','296315247','298283467','302667711','341510005','302670334','341526628','302672338','302674900','305803921','305804748','307755688','314129862','314129973','314139534','316967412','316967419','221886133','316980999','316981409','316988435','268046108','320145272','320163903','320171964','322189190','322189248','324175356','324189847','326629451','326629674','347671997','329349487','331744426','331749076','347684828','352795596','383248252','355585790','355587844','355593370','347679407','253352105','362577975','355583658','225421266','352786959','374354903','374359908','379291602','379320079','383226793','383250578','387163412','390369105','390370019','244397377','246721127','274533433','316978144','314124184','265752784','236516494','241504618','252387904','260383824','270504221','223287488','272257929','274561446','274555713','277449823','270504747','260406150','286522808','294413146','294420055','250366408','296293459','298257149','298279600','298280994','300286012','302649472','258088994','298270005','311432422','227096454','323078483','323083106','324174445','326600220','350651425','367060545','341512223','324187852','350656995','350660156','374355684','374352651','244392356','346720491','329792729','329793138','264189117','226104085','230777148','334235671','237147673','237171367','237157651','237154146','237154148','236511637','268050261','244384327','270501224','270500269','246711205','249168456','270517891','270499849','249187174','250366885','249173869','237153362','252386796','247994450','251220526','250354860','249180527','258082068','252392167','258091924','260374592','272237270','260378031','251227475','244389379','244385309','245594601','260384813','272245197','221891374','237172603','254649097','252392319','258094135','258106688','260386205','264198041','260397571','260404574','264201507','268050277','263391688','264185938','258107507','247990981','265751188','272237572','236506425','260399867','334247397','161825658','194931409','196159623','214139188','277447667','352788953','270520003','227103778','265756126','272259605','279990183','334234617','279998957','258098108','283086924','334265642','284690658','290122058','292202620','294392266','296301706','263392558','298255214','298283702','302647976','302661442','305794627','320155220','320155214','307739725','311433291','311453167','311456300','311456369','343867719','334250283','238520005','314135847','316994552','320146993','206242052','224473776','336502142','283096361','270501800','270501981','270500905','270501785','272262327','279976549','268052297','268052277','302645324','279976531','279976537','279976535','279976543','272246582','272259013','272247617','274542225','236519106','213256854','279987855','331756511','99026747','139167107','155419406','103057640','193010900','221070638','223281436','227082794','218730387','226110373','230776126','221055209','227095085','234750410','237154926','237154930','219449913','223308402','240702467','240702489','240702486','240702493','240702495','240702514','241501830','244396635','219462205','242643411','265777217','219462195','219461538','219462190','242615285','237167712','265765925','249193210','227089407','253348473','227089389','242614776','258094997','249185923','246723289','242637741','242637739','242637737','240702809','227114908','227113138','253350651','226123815','240702717','258112479','249190236','244407778','242616243','242643417','249190201','254640188','240702787','270514346','265777233','219462178','264176429','225419813','219455852','219454396','219453195','220307254','221054097','221054104','221891067','221891111','221891021','223283540','223283570','223284168','223284192','223304805','223300394','224467592','224467578','226118161','224470840','227089450','227101239','237162354','237156853','338570501','292203775','296318423','331746719','338570559','338570579','130286268','161826637','196176324','338570536','338570613','311459441','294410316','294411795','320166045','329798374','294414429','367054983','374360677','374360697','379320209','371901021','383230157','383230181','387170173','374351078','190198420','230772116','230193255','227101046','227104002','196161278','221890555','230777496','230777495','227113295','230774441','191564690','193895698','196179614','223291191','194909423','230776497','230188344','230778309','221068445','227111551','194906014','233800340','199427915','236505742','227084331','236508195','237149419','221873195','237143259','237152559','237152589','237159486','236518493','227086325','237166178','235372948','224463200','236514809','268042514','268046292','223297122','236511085','225413652','236511175','236517301','237154608','230187832','238537833','242615898','230194306','238521893','238521948','237154894','238522164','196162784','193915694','199429870','238524231','241504120','238528312','238519601','238519620','244405685','239602987','244387828','242618764','239606843','244397057','237149491','224473111','244397180','242633346','237166284','221884868','244411540','244407175','242629989','242644100','196161083','245581540','236349528','246735203','245581872','248002536','242635664','238527040','244400048','245587268','246714990','223284853','196180708','194916574','246740562','238519354','249173530','249183319','245588534','251222776','223297366','217382828','221882501','223303667','265762679','227112378','237147771','221873941','252383668','251226775','258110200','253350962','260390570','258100031','258112598','260396553','260385664','260394395','263403754','263403941','263404242','263405053','263405406','264184169','263404924','263405381','263403928','263403972','263404811','263403949','263403798','263404106','263404191','263404670','263404791','263405371','263405088','263403875','263404520','263399018','263406193','199430578','263396963','267291733','219457035','224472543','278712310','286514580','250367087','294403099','390373335','390373365','371886119','374360593','379295879','383222691','314116324','320163405','324192603','316979763','367051827','367052996','371894818','371895507','374344662','374349840','374350321','374359930','374372078','379295525','379306620','379313282','383222296','383234641','383234165','383239999','383240441','383253336','383253785','387159655','387160129','387161521','389285086','389285600','390373335','390373365','338565428','40342104','40344299','41870304','40345936','20531774','20543190','24938961','27760109','36002872','36001293','20532015','24940240','21170823','90407640','97061944','158435503','124716619','131793114','130777862','130777849','116359525','92374040','88378126','92373646','63445923','84018774','84018857','57639442','58101760','60592363','60592375','60588801','69015317','69998746','69998755','83136050','20515609','20517250','32087043','32094310','31529931','32082552','32105750','36003006','36003376','36000137','41167532','41847207','47663560','47665710','51905779','49516150','53318897','53322816','55875177','58101773','60589130','61211828','62821958','63445697','64325133','88378128','94830851','113082749','147849703','158434525','158435737','158436693','158436482','158435392','158436562','158436492','158436479','158434562','161816195','161822192','161828725','189402621','190191998','190212271','193902921','196179903','58111952','158435990','189401962','158435968','161812076','41158392','69998749','83133854','49514424','55883366','58103978','19440409','124093246','32101484','19440313','8093882','54597133','47657632','336515838','336497386','331753453','226106605','196153546','196153548','272249129','152963005','196170020','251219970','316974642','316974654','316974660','316978541','316979976','316983289','316983286','316983317','316989718','316990322','320150543','347689413','326618799','270511296','329795837','350650846','338563593','354142093','358745227','355578939','366411856','367051263','374348560','374351855','379292561','379292638','379292663','379292740','379292819','379292820','379292782','379292810','379292807','379292828','379292829','379292831','379292844','379292854','379294556','190207296','190207299','226107794','268057387','189402820','194926720','194929555','196151859','242632002','242630681','249189897','270517423','286521935','374349425','316982608','272249129','45887368','268063834','97059786','193891883','193906926','45887693','190185637','193906923','237154065','248007012','47672443','161827352','193905260','336494947','336494951','336516190','276758948','334263085','224464127','336501292','226106949','383227898','270532238','253356966','305792597','301302012','279998588','314135988','350670248','352789266','354152512','367061280','374349124','343869768','272246514','199444211','260377828','117704549','307740619','350661533','352795473','387170067','46473869','311455767','323083653','326627537','374367864','347676055','350677327','352780991','193892240','296306612','320170247','355578581','292198430','354144940','320170247','355578581','270506699','270532393','270506748','270531376','270514473','270507401','270530640','270506835','270506812','270507238','270531490','272256378','272239805','272255313','272240593','367042009','374368412','355566615','367040255','367053221','367054575','367065005','367050442','374357667','379317643','379290735','379293836','379305128','383225795','390366083','390366705','390369529','390376556','390377161','390377394','390377629','316990838','343875393','367041530','294417056','294416968','294417035','294417261','294417297','294417318','294417380','294417461','294417701','294417739','294417742','294417812','294417897','294417900','294417912','294417951','294418053','294418063','294418240','294418364','294418365','294418374','294418381','294418397','294418456','294418467','294418489','294418067','387166498','251227667','194926443','347681957',
    ]

    # Loop through the URLs and save each page
    for url in urls_to_save:
        save_page_with_context_menu("https://confluence.bbpd.io/pages/viewinfo.action?pageId=" + url)
        page_id = url.split('=')[-1]
        nombre_archivo = f"{page_id}"
        ruta_descargas = os.path.expanduser("~/Downloads")
        ruta_archivo_comprimido = os.path.join(ruta_descargas, f"{nombre_archivo}.tar.gz")
        ejecutar_comando_linux(f'find {ruta_descargas} -type f ! -name "*.zip" -exec tar -czvf {ruta_archivo_comprimido} {{}} +')
        ejecutar_comando_linux('find ~/Downloads -type f ! -name "*.tar.gz" -exec rm {} +')
        ejecutar_comando_linux('find ~/Downloads -type d ! -path "~/Downloads" -exec rmdir {} \;')
        ejecutar_comando_linux('mv ~/Downloads/* /Users/apulecio/Desktop/56529/files-to-upload')
    print("Process completed. Web pages have been saved.")

if __name__ == "__main__":
    main()
